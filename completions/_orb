#compdef orb

_orb() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    _arguments -C \
        '1: :->cmds' \
        '*::arg:->args'

    case "$state" in
        cmds)
            # First level: main commands
            _values 'orb commands' \
                'run[Run command on Linux]' \
                'start[Start OrbStack or a machine]' \
                'stop[Stop OrbStack or a machine]' \
                'status[Check whether OrbStack is running]' \
                'list[List machines]' \
                'help[Help about any command]'
            ;;
        args)
            # Second level: subcommands
            case ${words[1]} in
                run)
                    _orbctl_run
                    ;;
                start|stop)
                    _orbctl_machines
                    ;;
                *)
                    _orbctl
                    ;;
            esac
            ;;
    esac
}

_orbctl_run() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    _arguments -C \
        '-m[Specify machine]:machine:->machines' \
        '-u[Specify user]:user:_users' \
        '*::command:->command'

    case "$state" in
        machines)
            _orbctl_machines
            ;;
        command)
            _command_names
            ;;
    esac
}

_orbctl_machines() {
    local machines
    machines=($(orbctl list --format '{{.Name}}' 2>/dev/null))
    _values 'machines' $machines
}

compdef _orb orb
