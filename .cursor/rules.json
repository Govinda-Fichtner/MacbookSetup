{
  "version": 1,
  "rules": [
    {
      "name": "shell-script-validation",
      "description": "Enforce shell script best practices and prevent common CI errors",
      "documentation": {
        "url": "https://www.shellcheck.net/wiki",
        "description": "Rules to prevent common shell script CI errors and ensure proper validation.",
        "guidelines": [
          "Always run ShellCheck after every change of shell scripts to ensure they are not flawed",
          "Use absolute paths when sourcing files to prevent ShellCheck SC1091 errors",
          "Add proper ShellCheck directives for known exceptions",
          "Control command output in CI environments",
          "Maintain consistent shell script headers",
          "Use zsh as primary shell with bash compatibility mode for ShellCheck"
        ],
        "disabled_rules": {
          "SC1091": "Not following source - needed for dynamic includes",
          "SC2296": "Parameter expansion array access - needed for zsh compatibility",
          "SC2034": "Unused variables - needed for zsh compatibility",
          "SC2154": "Referenced but not assigned - needed for zsh compatibility",
          "SC2016": "Expressions in single quotes - needed for eval safety"
        }
      },
      "patterns": [
        {
          "pattern": "\\.sh$",
          "checks": [
            {
              "type": "shellcheck",
              "options": {
                "shell": "bash",
                "severity": "style",
                "external-sources": true,
                "check-sourced": true,
                "source-path": ["${workspace}", "${workspace}/lib", "${HOME}"],
                "disable": ["SC1091", "SC2296", "SC2034", "SC2154", "SC2016"],
                "enable": ["all"],
                "format": "json"
              }
            },
            {
              "type": "regex",
              "pattern": "^#!/bin/zsh\\n# shellcheck shell=bash\\n# shellcheck disable=([A-Z0-9,]+)$",
              "message": "Shell scripts should have proper header with shellcheck directives",
              "inverse": true,
              "severity": "error"
            },
            {
              "type": "regex",
              "pattern": "source\\s+[\"']?[^/$]",
              "message": "Use absolute paths or ./ prefix when sourcing files",
              "severity": "warning"
            },
            {
              "type": "regex",
              "pattern": "\\bsource\\s+[\"']?\\$\\{?ZDOTDIR",
              "message": "When sourcing zsh config files, add # shellcheck disable=SC1091 above the line",
              "severity": "warning"
            },
            {
              "type": "regex",
              "pattern": "(?<!2>&1|>/dev/null)\\s+[|>]",
              "message": "Command output should be explicitly redirected in CI scripts",
              "severity": "warning"
            },
            {
              "type": "regex",
              "pattern": "eval\\s+\"\\$\\([^)]+\\)\"\\s*(?!>/dev/null)",
              "message": "Eval command output should be redirected to control CI output",
              "severity": "warning"
            }
          ]
        }
      ],
      "actions": {
        "on-save": "validate",
        "quick-fix": {
          "SC1091": {
            "pattern": "source\\s+([\"']?)(.*?)\\1",
            "replacement": "# shellcheck disable=SC1091\nsource $1$2$1"
          },
          "missing-header": {
            "pattern": "^#!.*\\n(?!# shellcheck)",
            "replacement": "#!/bin/zsh\n# shellcheck shell=bash\n# shellcheck disable=SC2296,SC2034,SC2154,SC1091\n"
          }
        }
      }
    },
    {
      "name": "ci-pre-commit-alignment",
      "description": "Ensure alignment between CI and pre-commit configurations",
      "patterns": [
        {
          "pattern": "\\.cirrus\\.yml$|\\.pre-commit-config\\.yaml$",
          "checks": [
            {
              "type": "regex",
              "pattern": "shellcheck.*--exclude=([^\\s]+)",
              "message": "ShellCheck exclude rules must match between CI and pre-commit configurations",
              "severity": "error"
            },
            {
              "type": "regex",
              "pattern": "shellcheck.*--source-path=([^\\s]+)",
              "message": "ShellCheck source paths must match between CI and pre-commit configurations",
              "severity": "error"
            },
            {
              "type": "regex",
              "pattern": "shfmt.*-i\\s+([0-9]+)",
              "message": "shfmt indentation settings must be consistent across configurations",
              "severity": "error"
            }
          ]
        }
      ],
      "actions": {
        "on-save": "validate",
        "on-commit": {
          "command": "cirrus validate && open https://cirrus-ci.com/github/Govinda-Fichtner/MacbookSetup",
          "message": "Opening Cirrus CI dashboard for build monitoring. Please ensure the build passes before proceeding with further changes."
        }
      }
    },
    {
      "name": "ci-monitoring",
      "description": "Enforce CI monitoring practices and handle failures",
      "patterns": [
        {
          "pattern": ".*",
          "checks": [
            {
              "type": "commit",
              "options": {
                "require-ci-check": true,
                "wait-for-completion": true,
                "auto-fix-attempts": 3,
                "monitor-url": "https://cirrus-ci.com/github/Govinda-Fichtner/MacbookSetup",
                "post-commit-actions": [
                  {
                    "command": "cirrus validate",
                    "message": "Validating configuration locally before CI run."
                  },
                  {
                    "command": "open https://cirrus-ci.com/github/Govinda-Fichtner/MacbookSetup",
                    "message": "Opening Cirrus CI dashboard. Monitor the build and address any failures."
                  }
                ],
                "failure-actions": [
                  {
                    "command": "./scripts/ci_notify.sh failure",
                    "message": "Notifying of CI build failure"
                  }
                ],
                "success-actions": [
                  {
                    "command": "./scripts/ci_notify.sh success",
                    "message": "Notifying of CI build success"
                  }
                ]
              }
            }
          ]
        }
      ],
      "documentation": {
        "description": "Rules to ensure proper CI monitoring and failure handling",
        "guidelines": [
          "Monitor CI runs after each commit via web interface and notifications",
          "Check verification logs for specific errors",
          "Address failing checks immediately",
          "Ensure all required tools are installed via Brewfile",
          "Keep build status green",
          "Run local validation before pushing",
          "Review build failure logs in ~/.cirrus/logs/build_failures.log"
        ]
      }
    }
  ],
  "settings": {
    "shell-script-validation": {
      "enabled": true,
      "autofix": true
    },
    "ci-pre-commit-alignment": {
      "enabled": true,
      "autofix": false
    },
    "ci-monitoring": {
      "enabled": true,
      "autofix": false,
      "web-monitoring": true,
      "notification": {
        "enabled": true,
        "sounds": true,
        "log-failures": true
      },
      "verify-checks": [
        "docker",
        "orb",
        "kubectl",
        "helm",
        "docker_completion",
        "orb_completion",
        "kubectl_completion",
        "helm_completion",
        "terraform_completion"
      ]
    }
  }
} 