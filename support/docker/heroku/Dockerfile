# Generated by https://smithery.ai. See: https://smithery.ai/docs/config#dockerfile
# syntax=docker/dockerfile:1

# Use single stage for easier debugging
FROM node:20-alpine
WORKDIR /app

# Install required packages for Heroku CLI first
RUN echo "=== Installing system packages ===" && \
    apk add --no-cache curl bash ca-certificates && \
    echo "System packages installed successfully"

# Install Heroku CLI early with extensive debugging
RUN echo "=== Starting Heroku CLI installation ===" && \
    echo "Architecture: $(uname -m)" && \
    echo "Downloading installer..." && \
    curl -L https://cli-assets.heroku.com/install.sh > /tmp/heroku-install.sh && \
    echo "Installer downloaded, size: $(wc -c < /tmp/heroku-install.sh) bytes" && \
    chmod +x /tmp/heroku-install.sh && \
    echo "Running installer..." && \
    /tmp/heroku-install.sh && \
    echo "Installer completed, checking installation..." && \
    ls -la /usr/local/bin/ | grep heroku && \
    which heroku && \
    heroku version && \
    echo "=== Heroku CLI installation completed successfully ==="

# Install dependencies and build
COPY package.json package-lock.json tsconfig.json ./
RUN npm ci --ignore-scripts

COPY src ./src
RUN npm run build

# Install production dependencies
RUN npm ci --omit=dev --production --ignore-scripts

# Copy bin directory
COPY bin ./bin

# Ensure executable permissions
RUN chmod +x dist/index.js bin/heroku-mcp-server.mjs

# Final verification
RUN echo "=== Final verification ===" && \
    which heroku && \
    heroku version && \
    echo "=== All checks passed ==="

# Create non-root user for security
RUN addgroup -g 1001 -S appgroup && \
    adduser -u 1001 -S appuser -G appgroup -h /app && \
    mkdir -p /app/tmp /app/logs && \
    chown appuser:appgroup /app/tmp /app/logs && \
    chmod 755 /app/src /app/dist /app/bin /app/node_modules && \
    chmod 644 /app/package.json /app/package-lock.json /app/tsconfig.json

# Switch to non-root user
USER appuser

# Use the correct entrypoint as specified in PR #67
ENTRYPOINT ["node", "bin/heroku-mcp-server.mjs"]
